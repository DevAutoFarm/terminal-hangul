import Foundation

/// QWERTY 키보드 -> 두벌식 자모 매핑 테이블
enum JamoTable {

    // MARK: - QWERTY -> 자모 문자 매핑

    /// QWERTY 키 -> 한글 자모 매핑 (소문자)
    static let qwertyToJamo: [Character: Character] = [
        // 자음
        "r": "\u{3131}",  // ㄱ
        "R": "\u{3132}",  // ㄲ
        "s": "\u{3134}",  // ㄴ
        "e": "\u{3137}",  // ㄷ
        "E": "\u{3138}",  // ㄸ
        "f": "\u{3139}",  // ㄹ
        "a": "\u{3141}",  // ㅁ
        "q": "\u{3142}",  // ㅂ
        "Q": "\u{3143}",  // ㅃ
        "t": "\u{3145}",  // ㅅ
        "T": "\u{3146}",  // ㅆ
        "d": "\u{3147}",  // ㅇ
        "w": "\u{3148}",  // ㅈ
        "W": "\u{3149}",  // ㅉ
        "c": "\u{314A}",  // ㅊ
        "z": "\u{314B}",  // ㅋ
        "x": "\u{314C}",  // ㅌ
        "v": "\u{314D}",  // ㅍ
        "g": "\u{314E}",  // ㅎ

        // 모음
        "k": "\u{314F}",  // ㅏ
        "o": "\u{3150}",  // ㅐ
        "i": "\u{3151}",  // ㅑ
        "O": "\u{3152}",  // ㅒ
        "j": "\u{3153}",  // ㅓ
        "p": "\u{3154}",  // ㅔ
        "u": "\u{3155}",  // ㅕ
        "P": "\u{3156}",  // ㅖ
        "h": "\u{3157}",  // ㅗ
        "y": "\u{315B}",  // ㅛ
        "n": "\u{315C}",  // ㅜ
        "b": "\u{3160}",  // ㅠ
        "m": "\u{3161}",  // ㅡ
        "l": "\u{3163}",  // ㅣ
    ]

    // MARK: - 초성 (19개)
    // 유니코드 순서: ㄱ ㄲ ㄴ ㄷ ㄸ ㄹ ㅁ ㅂ ㅃ ㅅ ㅆ ㅇ ㅈ ㅉ ㅊ ㅋ ㅌ ㅍ ㅎ

    /// 자모 문자 -> 초성 인덱스 (0~18)
    static let jamoToChoseongIndex: [Character: Int] = [
        "\u{3131}": 0,   // ㄱ
        "\u{3132}": 1,   // ㄲ
        "\u{3134}": 2,   // ㄴ
        "\u{3137}": 3,   // ㄷ
        "\u{3138}": 4,   // ㄸ
        "\u{3139}": 5,   // ㄹ
        "\u{3141}": 6,   // ㅁ
        "\u{3142}": 7,   // ㅂ
        "\u{3143}": 8,   // ㅃ
        "\u{3145}": 9,   // ㅅ
        "\u{3146}": 10,  // ㅆ
        "\u{3147}": 11,  // ㅇ
        "\u{3148}": 12,  // ㅈ
        "\u{3149}": 13,  // ㅉ
        "\u{314A}": 14,  // ㅊ
        "\u{314B}": 15,  // ㅋ
        "\u{314C}": 16,  // ㅌ
        "\u{314D}": 17,  // ㅍ
        "\u{314E}": 18,  // ㅎ
    ]

    /// 초성 인덱스 -> 자모 문자
    static let choseongIndexToJamo: [Int: Character] = [
        0: "\u{3131}",   // ㄱ
        1: "\u{3132}",   // ㄲ
        2: "\u{3134}",   // ㄴ
        3: "\u{3137}",   // ㄷ
        4: "\u{3138}",   // ㄸ
        5: "\u{3139}",   // ㄹ
        6: "\u{3141}",   // ㅁ
        7: "\u{3142}",   // ㅂ
        8: "\u{3143}",   // ㅃ
        9: "\u{3145}",   // ㅅ
        10: "\u{3146}", // ㅆ
        11: "\u{3147}", // ㅇ
        12: "\u{3148}", // ㅈ
        13: "\u{3149}", // ㅉ
        14: "\u{314A}", // ㅊ
        15: "\u{314B}", // ㅋ
        16: "\u{314C}", // ㅌ
        17: "\u{314D}", // ㅍ
        18: "\u{314E}", // ㅎ
    ]

    // MARK: - 중성 (21개)
    // 유니코드 순서: ㅏ ㅐ ㅑ ㅒ ㅓ ㅔ ㅕ ㅖ ㅗ ㅘ ㅙ ㅚ ㅛ ㅜ ㅝ ㅞ ㅟ ㅠ ㅡ ㅢ ㅣ

    /// 자모 문자 -> 중성 인덱스 (0~20)
    static let jamoToJungseongIndex: [Character: Int] = [
        "\u{314F}": 0,   // ㅏ
        "\u{3150}": 1,   // ㅐ
        "\u{3151}": 2,   // ㅑ
        "\u{3152}": 3,   // ㅒ
        "\u{3153}": 4,   // ㅓ
        "\u{3154}": 5,   // ㅔ
        "\u{3155}": 6,   // ㅕ
        "\u{3156}": 7,   // ㅖ
        "\u{3157}": 8,   // ㅗ
        "\u{3158}": 9,   // ㅘ
        "\u{3159}": 10,  // ㅙ
        "\u{315A}": 11,  // ㅚ
        "\u{315B}": 12,  // ㅛ
        "\u{315C}": 13,  // ㅜ
        "\u{315D}": 14,  // ㅝ
        "\u{315E}": 15,  // ㅞ
        "\u{315F}": 16,  // ㅟ
        "\u{3160}": 17,  // ㅠ
        "\u{3161}": 18,  // ㅡ
        "\u{3162}": 19,  // ㅢ
        "\u{3163}": 20,  // ㅣ
    ]

    /// 중성 인덱스 -> 자모 문자
    static let jungseongIndexToJamo: [Int: Character] = [
        0: "\u{314F}",   // ㅏ
        1: "\u{3150}",   // ㅐ
        2: "\u{3151}",   // ㅑ
        3: "\u{3152}",   // ㅒ
        4: "\u{3153}",   // ㅓ
        5: "\u{3154}",   // ㅔ
        6: "\u{3155}",   // ㅕ
        7: "\u{3156}",   // ㅖ
        8: "\u{3157}",   // ㅗ
        9: "\u{3158}",   // ㅘ
        10: "\u{3159}", // ㅙ
        11: "\u{315A}", // ㅚ
        12: "\u{315B}", // ㅛ
        13: "\u{315C}", // ㅜ
        14: "\u{315D}", // ㅝ
        15: "\u{315E}", // ㅞ
        16: "\u{315F}", // ㅟ
        17: "\u{3160}", // ㅠ
        18: "\u{3161}", // ㅡ
        19: "\u{3162}", // ㅢ
        20: "\u{3163}", // ㅣ
    ]

    // MARK: - 종성 (28개, 0은 종성 없음)
    // 유니코드 순서: (없음) ㄱ ㄲ ㄳ ㄴ ㄵ ㄶ ㄷ ㄹ ㄺ ㄻ ㄼ ㄽ ㄾ ㄿ ㅀ ㅁ ㅂ ㅄ ㅅ ㅆ ㅇ ㅈ ㅊ ㅋ ㅌ ㅍ ㅎ

    /// 자모 문자 -> 종성 인덱스 (1~27, 0은 종성 없음)
    static let jamoToJongseongIndex: [Character: Int] = [
        "\u{3131}": 1,   // ㄱ
        "\u{3132}": 2,   // ㄲ
        "\u{3133}": 3,   // ㄳ (복합 종성)
        "\u{3134}": 4,   // ㄴ
        "\u{3135}": 5,   // ㄵ (복합 종성)
        "\u{3136}": 6,   // ㄶ (복합 종성)
        "\u{3137}": 7,   // ㄷ
        "\u{3139}": 8,   // ㄹ
        "\u{313A}": 9,   // ㄺ (복합 종성)
        "\u{313B}": 10,  // ㄻ (복합 종성)
        "\u{313C}": 11,  // ㄼ (복합 종성)
        "\u{313D}": 12,  // ㄽ (복합 종성)
        "\u{313E}": 13,  // ㄾ (복합 종성)
        "\u{313F}": 14,  // ㄿ (복합 종성)
        "\u{3140}": 15,  // ㅀ (복합 종성)
        "\u{3141}": 16,  // ㅁ
        "\u{3142}": 17,  // ㅂ
        "\u{3144}": 18,  // ㅄ (복합 종성)
        "\u{3145}": 19,  // ㅅ
        "\u{3146}": 20,  // ㅆ
        "\u{3147}": 21,  // ㅇ
        "\u{3148}": 22,  // ㅈ
        "\u{314A}": 23,  // ㅊ
        "\u{314B}": 24,  // ㅋ
        "\u{314C}": 25,  // ㅌ
        "\u{314D}": 26,  // ㅍ
        "\u{314E}": 27,  // ㅎ
    ]

    /// 종성 인덱스 -> 자모 문자
    static let jongseongIndexToJamo: [Int: Character] = [
        1: "\u{3131}",   // ㄱ
        2: "\u{3132}",   // ㄲ
        3: "\u{3133}",   // ㄳ
        4: "\u{3134}",   // ㄴ
        5: "\u{3135}",   // ㄵ
        6: "\u{3136}",   // ㄶ
        7: "\u{3137}",   // ㄷ
        8: "\u{3139}",   // ㄹ
        9: "\u{313A}",   // ㄺ
        10: "\u{313B}", // ㄻ
        11: "\u{313C}", // ㄼ
        12: "\u{313D}", // ㄽ
        13: "\u{313E}", // ㄾ
        14: "\u{313F}", // ㄿ
        15: "\u{3140}", // ㅀ
        16: "\u{3141}", // ㅁ
        17: "\u{3142}", // ㅂ
        18: "\u{3144}", // ㅄ
        19: "\u{3145}", // ㅅ
        20: "\u{3146}", // ㅆ
        21: "\u{3147}", // ㅇ
        22: "\u{3148}", // ㅈ
        23: "\u{314A}", // ㅊ
        24: "\u{314B}", // ㅋ
        25: "\u{314C}", // ㅌ
        26: "\u{314D}", // ㅍ
        27: "\u{314E}", // ㅎ
    ]

    // MARK: - 복합 모음 조합 테이블
    // (기존 중성 인덱스, 추가 중성 인덱스) -> 결과 중성 인덱스

    static let compoundVowels: [Int: [Int: Int]] = [
        // ㅗ(8) + ㅏ(0) = ㅘ(9), ㅗ(8) + ㅐ(1) = ㅙ(10), ㅗ(8) + ㅣ(20) = ㅚ(11)
        8: [0: 9, 1: 10, 20: 11],
        // ㅜ(13) + ㅓ(4) = ㅝ(14), ㅜ(13) + ㅔ(5) = ㅞ(15), ㅜ(13) + ㅣ(20) = ㅟ(16)
        13: [4: 14, 5: 15, 20: 16],
        // ㅡ(18) + ㅣ(20) = ㅢ(19)
        18: [20: 19],
    ]

    // MARK: - 복합 종성 조합 테이블
    // (기존 종성 인덱스, 추가 자모) -> 결과 종성 인덱스

    static let compoundJongseongs: [Int: [Character: Int]] = [
        // ㄱ(1) + ㅅ = ㄳ(3)
        1: ["\u{3145}": 3],
        // ㄴ(4) + ㅈ = ㄵ(5), ㄴ(4) + ㅎ = ㄶ(6)
        4: ["\u{3148}": 5, "\u{314E}": 6],
        // ㄹ(8) + ㄱ = ㄺ(9), ㄹ(8) + ㅁ = ㄻ(10), ㄹ(8) + ㅂ = ㄼ(11),
        // ㄹ(8) + ㅅ = ㄽ(12), ㄹ(8) + ㅌ = ㄾ(13), ㄹ(8) + ㅍ = ㄿ(14), ㄹ(8) + ㅎ = ㅀ(15)
        8: [
            "\u{3131}": 9,  // ㄱ
            "\u{3141}": 10, // ㅁ
            "\u{3142}": 11, // ㅂ
            "\u{3145}": 12, // ㅅ
            "\u{314C}": 13, // ㅌ
            "\u{314D}": 14, // ㅍ
            "\u{314E}": 15, // ㅎ
        ],
        // ㅂ(17) + ㅅ = ㅄ(18)
        17: ["\u{3145}": 18],
    ]

    // MARK: - 복합 종성 분리 테이블
    // 복합 종성 인덱스 -> (앞 자음 종성 인덱스, 뒤 자음 자모 문자)

    static let splitCompoundJongseong: [Int: (Int, Character)] = [
        3: (1, "\u{3145}"),   // ㄳ -> ㄱ + ㅅ
        5: (4, "\u{3148}"),   // ㄵ -> ㄴ + ㅈ
        6: (4, "\u{314E}"),   // ㄶ -> ㄴ + ㅎ
        9: (8, "\u{3131}"),   // ㄺ -> ㄹ + ㄱ
        10: (8, "\u{3141}"),  // ㄻ -> ㄹ + ㅁ
        11: (8, "\u{3142}"),  // ㄼ -> ㄹ + ㅂ
        12: (8, "\u{3145}"),  // ㄽ -> ㄹ + ㅅ
        13: (8, "\u{314C}"),  // ㄾ -> ㄹ + ㅌ
        14: (8, "\u{314D}"),  // ㄿ -> ㄹ + ㅍ
        15: (8, "\u{314E}"),  // ㅀ -> ㄹ + ㅎ
        18: (17, "\u{3145}"), // ㅄ -> ㅂ + ㅅ
    ]

    // MARK: - 종성 -> 초성 변환
    // 종성 인덱스 -> 초성 인덱스 (종성이 다음 글자의 초성으로 이동할 때)

    static let jongseongToChoseong: [Int: Int] = [
        1: 0,   // ㄱ
        2: 1,   // ㄲ
        4: 2,   // ㄴ
        7: 3,   // ㄷ
        8: 5,   // ㄹ
        16: 6,  // ㅁ
        17: 7,  // ㅂ
        19: 9,  // ㅅ
        20: 10, // ㅆ
        21: 11, // ㅇ
        22: 12, // ㅈ
        23: 14, // ㅊ
        24: 15, // ㅋ
        25: 16, // ㅌ
        26: 17, // ㅍ
        27: 18, // ㅎ
    ]

    // MARK: - 유틸리티 메서드

    /// 자모가 자음인지 확인
    static func isConsonant(_ jamo: Character) -> Bool {
        let scalar = jamo.unicodeScalars.first!.value
        // 호환 자모 영역에서 자음: ㄱ(0x3131) ~ ㅎ(0x314E)
        return scalar >= 0x3131 && scalar <= 0x314E
    }

    /// 자모가 모음인지 확인
    static func isVowel(_ jamo: Character) -> Bool {
        let scalar = jamo.unicodeScalars.first!.value
        // 호환 자모 영역에서 모음: ㅏ(0x314F) ~ ㅣ(0x3163)
        return scalar >= 0x314F && scalar <= 0x3163
    }

    /// 자음이 초성으로 사용 가능한지 확인
    static func canBeChoseong(_ jamo: Character) -> Bool {
        return jamoToChoseongIndex[jamo] != nil
    }

    /// 자음이 종성으로 사용 가능한지 확인
    static func canBeJongseong(_ jamo: Character) -> Bool {
        return jamoToJongseongIndex[jamo] != nil
    }

    /// 두 모음이 복합 모음을 만들 수 있는지 확인
    static func canCombineVowels(first: Int, second: Int) -> Int? {
        return compoundVowels[first]?[second]
    }

    /// 종성과 자음이 복합 종성을 만들 수 있는지 확인
    static func canCombineJongseong(current: Int, adding: Character) -> Int? {
        return compoundJongseongs[current]?[adding]
    }

    /// 복합 종성을 분리 (뒤 자음이 다음 초성으로 이동할 때)
    static func splitJongseong(_ jongseongIndex: Int) -> (remaining: Int, nextChoseong: Character)? {
        return splitCompoundJongseong[jongseongIndex]
    }

    /// 종성을 초성 인덱스로 변환
    static func jongseongToChoseongIndex(_ jongseongIndex: Int) -> Int? {
        return jongseongToChoseong[jongseongIndex]
    }
}
